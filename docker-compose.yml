version: '2'

volumes:
   symfony_cache:
   symfony_logs:
   mysql_data:
   rabbit_data:

services:
  mysql:
    image: mysql:5.6
    container_name: mysql
    environment:
      - MYSQL_ROOT_PASSWORD=root
      - MYSQL_DATABASE=symfony
      - MYSQL_USER=symfony
      - MYSQL_PASSWORD=password
    ports:
      - "33306:3306"
    volumes:
      - mysql_data:/var/lib/mysql

  nginx:
    build: nginx
    container_name: nginx
    volumes_from:
      - php-fpm
    ports:
      - "8080:80"
    links:
      - php-fpm

  php-fpm:
    build: php-fpm
    container_name: php-fpm
    volumes:
      - ./:/var/www/rest_api
      - symfony_cache:/var/www/rest_api/var/cache
      - symfony_logs:/var/www/rest_api/var/logs
    links:
      - mysql
      - rabbitmq
      - redis
      - elasticsearch

  phpmyadmin:
    image: phpmyadmin/phpmyadmin:latest
    container_name: phpmyadmin
    links:
      - mysql:mysql
    environment:
      - MYSQL_USERNAME=root
      - MYSQL_ROOT_PASSWORD=root
      - PMA_ARBITRARY=1
    ports:
      - 8090:80
      
  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq
    volumes:
      - rabbit_data:/var/lib/rabbitmq
    ports:
      - "25671:5672"
      - "25672:15672"
    environment:
      RABBITMQ_ERLANG_COOKIE: rabbit
      RABBITMQ_DEFAULT_USER: ruser
      RABBITMQ_DEFAULT_PASS: rpass
      RABBITMQ_DEFAULT_VHOST: /

  redis:
    build: docker/redis
    ports:
      - "6379"

  elasticsearch:
    image: elasticsearch:latest
    command: elasticsearch -Des.network.host=0.0.0.0
    ports:
      - "9200:9200"
      - "9300:9300"

  logstash:
    image: logstash:latest
    command: logstash -f /etc/logstash/conf.d/logstash.conf
    volumes:
      - ./docker/logstash:/etc/logstash/conf.d
    ports:
      - "5000:5000"
    links:
      - elasticsearch

  kibana:
    build: docker/kibana
    volumes:
      - ./docker/kibana/config/:/opt/kibana/config/
    ports:
      - "5601:5601"
    links:
      - elasticsearch
